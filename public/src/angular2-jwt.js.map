{"version":3,"sources":["src/angular2-jwt.ts"],"names":["tokenNotExpired","AuthConfig","AuthConfig.constructor","AuthConfig.getConfig","AuthHttp","AuthHttp.constructor","AuthHttp._request","AuthHttp.requestHelper","AuthHttp.get","AuthHttp.post","AuthHttp.put","AuthHttp.delete","AuthHttp.patch","AuthHttp.head","JwtHelper","JwtHelper.constructor","JwtHelper.urlBase64Decode","JwtHelper.decodeToken","JwtHelper.getTokenExpirationDate","JwtHelper.isTokenExpired"],"mappings":";;;;;;;;;;;;IA2MA;;;OAGG;IAEH,yBAAgC,SAAiB,EAAE,GAAW;QAE5DA,IAAIA,SAASA,GAAUA,SAASA,IAAIA,UAAUA,CAACA;QAC/CA,IAAIA,KAAYA,CAACA;QAEjBA,EAAEA,CAAAA,CAACA,GAAGA,CAACA,CAACA,CAACA;YACPA,KAAKA,GAAGA,GAAGA,CAACA;QACdA,CAACA;QACDA,IAAIA,CAACA,CAACA;YACJA,KAAKA,GAAGA,YAAYA,CAACA,OAAOA,CAACA,SAASA,CAACA,CAACA;QAC1CA,CAACA;QAEDA,IAAIA,SAASA,GAAGA,IAAIA,SAASA,EAAEA,CAACA;QAEhCA,EAAEA,CAAAA,CAACA,CAACA,KAAKA,IAAIA,SAASA,CAACA,cAAcA,CAACA,KAAKA,EAAEA,IAAIA,CAACA,CAACA,CAACA,CAACA;YACnDA,MAAMA,CAACA,KAAKA,CAACA;QACfA,CAACA;QAEDA,IAAIA,CAACA,CAACA;YACJA,MAAMA,CAACA,IAAIA,CAACA;QACdA,CAACA;IACHA,CAACA;IArBD,6CAqBC,CAAA;;;;;;;;;;;;;YAtND;;eAEG;YAEH;gBASEC,oBAAYA,MAAYA;oBAT1BC,iBAgCCA;oBAtBGA,IAAIA,CAACA,MAAMA,GAAGA,MAAMA,IAAIA,EAAEA,CAACA;oBAC3BA,IAAIA,CAACA,UAAUA,GAAGA,IAAIA,CAACA,MAAMA,CAACA,UAAUA,IAAIA,eAAeA,CAACA;oBAC5DA,EAAEA,CAAAA,CAACA,IAAIA,CAACA,MAAMA,CAACA,YAAYA,CAACA,CAACA,CAACA;wBAC5BA,IAAIA,CAACA,YAAYA,GAAGA,IAAIA,CAACA,MAAMA,CAACA,YAAYA,GAAGA,GAAGA,CAACA;oBACrDA,CAACA;oBAACA,IAAIA,CAACA,CAACA;wBACNA,IAAIA,CAACA,YAAYA,GAAGA,SAASA,CAACA;oBAChCA,CAACA;oBACDA,IAAIA,CAACA,SAASA,GAAGA,IAAIA,CAACA,MAAMA,CAACA,SAASA,IAAIA,UAAUA,CAACA;oBACrDA,IAAIA,CAACA,UAAUA,GAAGA,IAAIA,CAACA,MAAMA,CAACA,UAAUA,IAAIA,KAAKA,CAACA;oBAClDA,IAAIA,CAACA,WAAWA,GAAGA,IAAIA,CAACA,MAAMA,CAACA,WAAWA,IAAIA,CAACA,cAAMA,OAAAA,YAAYA,CAACA,OAAOA,CAACA,KAAIA,CAACA,SAASA,CAACA,EAApCA,CAAoCA,CAACA,CAACA;gBAC7FA,CAACA;gBAEDD,8BAASA,GAATA;oBACEE,MAAMA,CAACA;wBACLA,UAAUA,EAAEA,IAAIA,CAACA,UAAUA;wBAC3BA,YAAYA,EAAEA,IAAIA,CAACA,YAAYA;wBAC/BA,SAASA,EAAEA,IAAIA,CAACA,SAASA;wBACzBA,WAAWA,EAAEA,IAAIA,CAACA,WAAWA;wBAC7BA,UAAUA,EAAEA,IAAIA,CAACA,UAAUA;qBAC5BA,CAAAA;gBACHA,CAACA;gBAEHF,iBAACA;YAADA,CAhCA,AAgCCA,IAAA;YAhCD,mCAgCC,CAAA;YAED;;eAEG;YAEH;gBAMEG,kBAAYA,OAAmBA,EAAUA,IAAUA;oBANrDC,iBAmFCA;oBA7E0CA,SAAIA,GAAJA,IAAIA,CAAMA;oBACjDA,IAAIA,CAACA,OAAOA,GAAGA,OAAOA,CAACA,SAASA,EAAEA,CAACA;oBAEnCA,IAAIA,CAACA,WAAWA,GAAGA,IAAIA,uBAAUA,CAACA,UAACA,GAAQA;wBACzCA,GAAGA,CAACA,IAAIA,CAACA,KAAIA,CAACA,OAAOA,CAACA,WAAWA,EAAEA,CAACA,CAAAA;oBACtCA,CAACA,CAACA,CAACA;gBACLA,CAACA;gBAEDD,2BAAQA,GAARA,UAASA,GAAqBA,EAAEA,OAA4BA;oBAE1DE,IAAIA,OAAWA,CAACA;oBAEhBA,EAAEA,CAAAA,CAACA,CAACA,eAAeA,CAACA,IAAIA,EAAEA,IAAIA,CAACA,OAAOA,CAACA,WAAWA,EAAEA,CAACA,CAACA,CAACA,CAACA;wBACtDA,EAAEA,CAAAA,CAACA,CAACA,IAAIA,CAACA,OAAOA,CAACA,UAAUA,CAACA,CAACA,CAACA;4BAC5BA,MAAMA,aAAaA,CAACA;wBACtBA,CAACA;wBAACA,IAAIA,CAACA,CAACA;4BACNA,OAAOA,GAAGA,IAAIA,CAACA,IAAIA,CAACA,OAAOA,CAACA,GAAGA,EAAEA,OAAOA,CAACA,CAACA;wBAC5CA,CAACA;oBAEHA,CAACA;oBAACA,IAAIA,CAACA,EAAEA,CAAAA,CAACA,OAAOA,GAAGA,KAAKA,QAAQA,CAACA,CAACA,CAACA;wBAClCA,IAAIA,OAAOA,GAAGA,OAAOA,IAAIA,EAAEA,CAACA;wBAE5BA,EAAEA,CAAAA,CAACA,CAACA,OAAOA,CAACA,OAAOA,CAACA,CAACA,CAACA;4BACpBA,OAAOA,CAACA,OAAOA,GAAGA,IAAIA,cAAOA,EAAEA,CAACA;wBAClCA,CAACA;wBAEDA,OAAOA,CAACA,OAAOA,CAACA,GAAGA,CAACA,IAAIA,CAACA,OAAOA,CAACA,UAAUA,EAAEA,IAAIA,CAACA,OAAOA,CAACA,YAAYA,GAAGA,IAAIA,CAACA,OAAOA,CAACA,WAAWA,EAAEA,CAACA,CAACA;wBACrGA,OAAOA,GAAGA,IAAIA,CAACA,IAAIA,CAACA,OAAOA,CAACA,GAAGA,EAAEA,OAAOA,CAACA,CAACA;oBAE5CA,CAACA;oBAACA,IAAIA,CAACA,CAACA;wBACNA,IAAIA,GAAGA,GAAoBA,GAAGA,CAACA;wBAE/BA,EAAEA,CAAAA,CAACA,CAACA,GAAGA,CAACA,OAAOA,CAACA,CAACA,CAACA;4BAChBA,GAAGA,CAACA,OAAOA,GAAGA,IAAIA,cAAOA,EAAEA,CAACA;wBAC9BA,CAACA;wBAEDA,GAAGA,CAACA,OAAOA,CAACA,GAAGA,CAACA,IAAIA,CAACA,OAAOA,CAACA,UAAUA,EAAEA,IAAIA,CAACA,OAAOA,CAACA,YAAYA,GAAGA,IAAIA,CAACA,OAAOA,CAACA,WAAWA,EAAEA,CAACA,CAACA;wBACjGA,OAAOA,GAAGA,IAAIA,CAACA,IAAIA,CAACA,OAAOA,CAACA,GAAGA,CAACA,CAACA;oBACnCA,CAACA;oBAEDA,MAAMA,CAACA,OAAOA,CAACA;gBACjBA,CAACA;gBAEOF,gCAAaA,GAArBA,UAAsBA,WAA+BA,EAAEA,iBAAqCA;oBAC1FG,IAAIA,OAAOA,GAAGA,IAAIA,qBAAcA,CAACA,WAAWA,CAACA,CAACA;oBAE9CA,EAAEA,CAAAA,CAACA,iBAAiBA,CAACA,CAACA,CAACA;wBACrBA,OAAOA,GAAGA,OAAOA,CAACA,KAAKA,CAACA,iBAAiBA,CAACA,CAAAA;oBAC5CA,CAACA;oBAEDA,MAAMA,CAACA,IAAIA,CAACA,QAAQA,CAACA,IAAIA,cAAOA,CAACA,OAAOA,CAACA,CAACA,CAAAA;gBAC5CA,CAACA;gBAEDH,sBAAGA,GAAHA,UAAIA,GAAWA,EAAEA,OAA4BA;oBAC3CI,MAAMA,CAACA,IAAIA,CAACA,aAAaA,CAACA,EAAEA,GAAGA,EAAGA,GAAGA,EAAEA,MAAMA,EAAEA,oBAAaA,CAACA,GAAGA,EAAEA,EAAEA,OAAOA,CAACA,CAACA;gBAC/EA,CAACA;gBAEDJ,uBAAIA,GAAJA,UAAKA,GAAWA,EAAEA,IAAYA,EAAEA,OAA4BA;oBAC1DK,MAAMA,CAACA,IAAIA,CAACA,aAAaA,CAACA,EAAEA,GAAGA,EAAGA,GAAGA,EAAEA,IAAIA,EAAEA,IAAIA,EAAEA,MAAMA,EAAEA,oBAAaA,CAACA,IAAIA,EAAEA,EAAEA,OAAOA,CAACA,CAACA;gBAC5FA,CAACA;gBAEDL,sBAAGA,GAAHA,UAAIA,GAAWA,EAAEA,IAAYA,EAAEA,OAA6BA;oBAC1DM,MAAMA,CAACA,IAAIA,CAACA,aAAaA,CAACA,EAAEA,GAAGA,EAAGA,GAAGA,EAAEA,IAAIA,EAAEA,IAAIA,EAAEA,MAAMA,EAAEA,oBAAaA,CAACA,GAAGA,EAAEA,EAAEA,OAAOA,CAACA,CAACA;gBAC3FA,CAACA;gBAEDN,yBAAMA,GAANA,UAAOA,GAAWA,EAAEA,OAA6BA;oBAC/CO,MAAMA,CAACA,IAAIA,CAACA,aAAaA,CAACA,EAAEA,GAAGA,EAAGA,GAAGA,EAAEA,MAAMA,EAAEA,oBAAaA,CAACA,MAAMA,EAAEA,EAAEA,OAAOA,CAACA,CAACA;gBAClFA,CAACA;gBAEDP,wBAAKA,GAALA,UAAMA,GAAWA,EAAEA,IAAWA,EAAEA,OAA4BA;oBAC1DQ,MAAMA,CAACA,IAAIA,CAACA,aAAaA,CAACA,EAAEA,GAAGA,EAAGA,GAAGA,EAAEA,IAAIA,EAAEA,IAAIA,EAAEA,MAAMA,EAAEA,oBAAaA,CAACA,KAAKA,EAAEA,EAAEA,OAAOA,CAACA,CAACA;gBAC7FA,CAACA;gBAEDR,uBAAIA,GAAJA,UAAKA,GAAWA,EAAEA,OAA4BA;oBAC5CS,MAAMA,CAACA,IAAIA,CAACA,aAAaA,CAACA,EAAEA,GAAGA,EAAGA,GAAGA,EAAEA,MAAMA,EAAEA,oBAAaA,CAACA,IAAIA,EAAEA,EAAEA,OAAOA,CAACA,CAACA;gBAChFA,CAACA;gBAjFHT;oBAACA,iBAAUA,EAAEA;;6BAmFZA;gBAADA,eAACA;YAADA,CAnFA,AAmFCA,IAAA;YAnFD,+BAmFC,CAAA;YAED;;eAEG;YAEH;gBAAAU;gBAuDAC,CAACA;gBArDQD,mCAAeA,GAAtBA,UAAuBA,GAAUA;oBAC/BE,IAAIA,MAAMA,GAAGA,GAAGA,CAACA,OAAOA,CAACA,IAAIA,EAAEA,GAAGA,CAACA,CAACA,OAAOA,CAACA,IAAIA,EAAEA,GAAGA,CAACA,CAACA;oBACvDA,MAAMA,CAACA,CAACA,MAAMA,CAACA,MAAMA,GAAGA,CAACA,CAACA,CAACA,CAACA;wBAC1BA,KAAKA,CAACA,EAAEA,CAACA;4BAACA,KAAKA,CAACA;wBAACA,CAACA;wBAClBA,KAAKA,CAACA,EAAEA,CAACA;4BAACA,MAAMA,IAAIA,IAAIA,CAACA;4BAACA,KAAKA,CAACA;wBAACA,CAACA;wBAClCA,KAAKA,CAACA,EAAEA,CAACA;4BAACA,MAAMA,IAAIA,GAAGA,CAACA;4BAACA,KAAKA,CAACA;wBAACA,CAACA;wBACjCA,SAASA,CAACA;4BACRA,MAAMA,2BAA2BA,CAACA;wBACpCA,CAACA;oBACHA,CAACA;oBAEDA,MAAMA,CAACA,kBAAkBA,CAACA,MAAMA,CAACA,MAAMA,CAACA,IAAIA,CAACA,MAAMA,CAACA,CAACA,CAACA,CAACA,CAACA,qDAAqDA;gBAC/GA,CAACA;gBAEMF,+BAAWA,GAAlBA,UAAmBA,KAAYA;oBAC7BG,IAAIA,KAAKA,GAAGA,KAAKA,CAACA,KAAKA,CAACA,GAAGA,CAACA,CAACA;oBAE7BA,EAAEA,CAACA,CAACA,KAAKA,CAACA,MAAMA,KAAKA,CAACA,CAACA,CAACA,CAACA;wBACvBA,MAAMA,IAAIA,KAAKA,CAACA,uBAAuBA,CAACA,CAACA;oBAC3CA,CAACA;oBAEDA,IAAIA,OAAOA,GAAGA,IAAIA,CAACA,eAAeA,CAACA,KAAKA,CAACA,CAACA,CAACA,CAACA,CAACA;oBAC7CA,EAAEA,CAACA,CAACA,CAACA,OAAOA,CAACA,CAACA,CAACA;wBACbA,MAAMA,IAAIA,KAAKA,CAACA,yBAAyBA,CAACA,CAACA;oBAC7CA,CAACA;oBAEDA,MAAMA,CAACA,IAAIA,CAACA,KAAKA,CAACA,OAAOA,CAACA,CAACA;gBAC7BA,CAACA;gBAEMH,0CAAsBA,GAA7BA,UAA8BA,KAAYA;oBACxCI,IAAIA,OAAYA,CAACA;oBACjBA,OAAOA,GAAGA,IAAIA,CAACA,WAAWA,CAACA,KAAKA,CAACA,CAACA;oBAElCA,EAAEA,CAAAA,CAACA,OAAOA,OAAOA,CAACA,GAAGA,KAAKA,WAAWA,CAACA,CAACA,CAACA;wBACtCA,MAAMA,CAACA,IAAIA,CAACA;oBACdA,CAACA;oBAEDA,IAAIA,IAAIA,GAAGA,IAAIA,IAAIA,CAACA,CAACA,CAACA,CAACA,CAACA,0DAA0DA;oBAClFA,IAAIA,CAACA,aAAaA,CAACA,OAAOA,CAACA,GAAGA,CAACA,CAACA;oBAEhCA,MAAMA,CAACA,IAAIA,CAACA;gBACdA,CAACA;gBAEMJ,kCAAcA,GAArBA,UAAsBA,KAAYA,EAAEA,aAAqBA;oBACvDK,IAAIA,IAAIA,GAAGA,IAAIA,CAACA,sBAAsBA,CAACA,KAAKA,CAACA,CAACA;oBAC9CA,aAAaA,GAAGA,aAAaA,IAAIA,CAACA,CAACA;oBACnCA,EAAEA,CAACA,CAACA,IAAIA,KAAKA,IAAIA,CAACA,CAACA,CAACA;wBAClBA,MAAMA,CAACA,KAAKA,CAACA;oBACfA,CAACA;oBAEDA,iBAAiBA;oBACjBA,MAAMA,CAACA,CAACA,CAACA,IAAIA,CAACA,OAAOA,EAAEA,GAAGA,CAACA,IAAIA,IAAIA,EAAEA,CAACA,OAAOA,EAAEA,GAAGA,CAACA,aAAaA,GAAGA,IAAIA,CAACA,CAACA,CAACA,CAACA;gBAC7EA,CAACA;gBACHL,gBAACA;YAADA,CAvDA,AAuDCA,IAAA;YAvDD,iCAuDC,CAAA","file":"src/angular2-jwt.js","sourcesContent":["import {Injectable, Injector} from 'angular2/core';\nimport {Http, HTTP_PROVIDERS, Headers, BaseRequestOptions, Request, RequestOptions, RequestOptionsArgs, RequestMethod, Response} from 'angular2/http';\nimport {Observable} from 'rxjs/Observable';\n\n// Avoid TS error \"cannot find name escape\"\ndeclare var escape: any;\n\nexport interface IAuthConfig {\n  headerName: string;\n  headerPrefix: string;\n  tokenName: string;\n  tokenGetter: any;\n  noJwtError: boolean;\n}\n\n/**\n * Sets up the authentication configuration.\n */\n\nexport class AuthConfig {\n  \n  config: any;\n  headerName: string;\n  headerPrefix: string;\n  tokenName: string;\n  tokenGetter: any;\n  noJwtError: boolean;\n\n  constructor(config?: any) {\n    this.config = config || {};\n    this.headerName = this.config.headerName || 'Authorization';\n    if(this.config.headerPrefix) {\n      this.headerPrefix = this.config.headerPrefix + ' ';\n    } else {\n      this.headerPrefix = 'Bearer ';\n    }\n    this.tokenName = this.config.tokenName || 'id_token';\n    this.noJwtError = this.config.noJwtError || false;\n    this.tokenGetter = this.config.tokenGetter || (() => localStorage.getItem(this.tokenName));\n  }\n\n  getConfig() {\n    return {\n      headerName: this.headerName,\n      headerPrefix: this.headerPrefix,\n      tokenName: this.tokenName,\n      tokenGetter: this.tokenGetter,\n      noJwtError: this.noJwtError\n    }\n  }\n\n}\n\n/**\n * Allows for explicit authenticated HTTP requests.\n */\n\n@Injectable()\nexport class AuthHttp {\n\n  private _config: IAuthConfig;\n  public tokenStream: Observable<string>;\n\n  constructor(options: AuthConfig, private http: Http) {\n    this._config = options.getConfig();\n\n    this.tokenStream = new Observable((obs: any) => {\n      obs.next(this._config.tokenGetter())\n    });\n  }\n\n  _request(url: string | Request, options?: RequestOptionsArgs) : Observable<Response> {\n\n    let request:any;\n    \n    if(!tokenNotExpired(null, this._config.tokenGetter())) {\n      if(!this._config.noJwtError) {\n        throw 'Invalid JWT';\n      } else {\n        request = this.http.request(url, options);\n      }\n      \n    } else if(typeof url === 'string') {\n      let reqOpts = options || {};\n      \n      if(!reqOpts.headers) {\n        reqOpts.headers = new Headers();\n      }\n      \n      reqOpts.headers.set(this._config.headerName, this._config.headerPrefix + this._config.tokenGetter());\n      request = this.http.request(url, reqOpts);\n      \n    } else {\n      let req:Request = <Request>url;\n      \n      if(!req.headers) {\n        req.headers = new Headers();\n      }\n      \n      req.headers.set(this._config.headerName, this._config.headerPrefix + this._config.tokenGetter());\n      request = this.http.request(req);\n    }\n    \n    return request;\n  }\n\n  private requestHelper(requestArgs: RequestOptionsArgs, additionalOptions: RequestOptionsArgs) : Observable<Response> {\n    let options = new RequestOptions(requestArgs);\n    \n    if(additionalOptions) {\n      options = options.merge(additionalOptions)\n    }\n    \n    return this._request(new Request(options))\n  }\n\n  get(url: string, options?: RequestOptionsArgs) : Observable<Response> {\n    return this.requestHelper({ url:  url, method: RequestMethod.Get }, options);\n  }\n\n  post(url: string, body: string, options?: RequestOptionsArgs) : Observable<Response> {\n    return this.requestHelper({ url:  url, body: body, method: RequestMethod.Post }, options);\n  }\n\n  put(url: string, body: string, options ?: RequestOptionsArgs) : Observable<Response> {\n    return this.requestHelper({ url:  url, body: body, method: RequestMethod.Put }, options);\n  }\n\n  delete(url: string, options ?: RequestOptionsArgs) : Observable<Response> {\n    return this.requestHelper({ url:  url, method: RequestMethod.Delete }, options);\n  }\n\n  patch(url: string, body:string, options?: RequestOptionsArgs) : Observable<Response> {\n    return this.requestHelper({ url:  url, body: body, method: RequestMethod.Patch }, options);\n  }\n\n  head(url: string, options?: RequestOptionsArgs) : Observable<Response> {\n    return this.requestHelper({ url:  url, method: RequestMethod.Head }, options);\n  }\n\n}\n\n/**\n * Helper class to decode and find JWT expiration.\n */\n\nexport class JwtHelper {\n\n  public urlBase64Decode(str:string) {\n    var output = str.replace(/-/g, '+').replace(/_/g, '/');\n    switch (output.length % 4) {\n      case 0: { break; }\n      case 2: { output += '=='; break; }\n      case 3: { output += '='; break; }\n      default: {\n        throw 'Illegal base64url string!';\n      }\n    }\n\n    return decodeURIComponent(escape(window.atob(output))); //polifyll https://github.com/davidchambers/Base64.js\n  }\n\n  public decodeToken(token:string) {\n    var parts = token.split('.');\n\n    if (parts.length !== 3) {\n      throw new Error('JWT must have 3 parts');\n    }\n\n    var decoded = this.urlBase64Decode(parts[1]);\n    if (!decoded) {\n      throw new Error('Cannot decode the token');\n    }\n\n    return JSON.parse(decoded);\n  }\n\n  public getTokenExpirationDate(token:string) {\n    var decoded: any;\n    decoded = this.decodeToken(token);\n\n    if(typeof decoded.exp === \"undefined\") {\n      return null;\n    }\n\n    var date = new Date(0); // The 0 here is the key, which sets the date to the epoch\n    date.setUTCSeconds(decoded.exp);\n\n    return date;\n  }\n\n  public isTokenExpired(token:string, offsetSeconds?:number) {\n    var date = this.getTokenExpirationDate(token);\n    offsetSeconds = offsetSeconds || 0;\n    if (date === null) {\n      return false;\n    }\n\n    // Token expired?\n    return !(date.valueOf() > (new Date().valueOf() + (offsetSeconds * 1000)));\n  }\n}\n\n/**\n * Checks for presence of token and that token hasn't expired.\n * For use with the @CanActivate router decorator and NgIf\n */\n\nexport function tokenNotExpired(tokenName?:string, jwt?:string) {\n\n  var authToken:string = tokenName || 'id_token';\n  var token:string;\n\n  if(jwt) {\n    token = jwt;\n  }\n  else {\n    token = localStorage.getItem(authToken);\n  }\n\n  var jwtHelper = new JwtHelper();\n  \n  if(!token || jwtHelper.isTokenExpired(token, null)) {\n    return false;\n  }\n\n  else {\n    return true;\n  }\n}\n"],"sourceRoot":"/source/"}